ASSEMBLEM

DC HEADERADD 	00128  	%  Header height
DC SCREENADD 	00120  	%  Screen
DC HORLOGE	0012E
DC HORLOGE2	0012F
DC TIMER2	00138
DC KEY    	0020F  	%  OUT=C C=IN
DC WTF		005DB	%  ?
DC HEXDCW 	2DEAA  	%  Make Hex
DC GEST 	8600D
DC GEST2	80092
DC REGBK	805F5	% Registers backup
DC SCREEN	8068D   % Screen address

% InterrupHandler49 constantes
CP=80319
DCCP 5 SAVSCREEN
DCCP 5 SCR
DCCP 8 SAV_TIMER
DCCP 10 COUNT_IT
DCCP 16 SAVE_IT
DCCP 1 COEFFIMAGE
DCCP 5 EC1             	% address of our offscreen surface1
DCCP 5 EC2             	% address of our offscreen surface2

!RPL

::
CODEM

SAVE

D1=(5)HEADERADD LC F DAT1=C.1 	% Remove menu

% create custom screen surface and store address in EC1
LC(5)$00AA1 GOSBVL =MAKE$N
D0+1 AD0EX ABIT=0.0
D0=(5)EC1 DAT0=A.A

% create custom screen surface and store address in EC2
LC(5)$00AA1 GOSBVL =MAKE$N
D0+1 AD0EX ABIT=0.0
D0=(5)EC2 DAT0=A.A

% Clear EC1
SKUBL {
$0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000087E0E700F7000EE3000000000000000000EFEFFFE7FF000F3F000000000000000000FFEFFFF7FF100F5E100000000000000000F5EFFFF7FF100FFF100000000000000000EBFFFFF3FF700EFF300000000000000000CFFFFFFFFFF00CFF3000000000000000008FFFFFFFFFF108FF3000000000000000008FFFFFFFFFE1E7EF300000000000000000EFFFFFFFFFE17CEF700000000000000000FFFFFFFFFFF1FFFFF00000000000000000FBFFFFFFFFF0FFFFF00000000000000000E9FFFFFFFFF0EFFFF00000000000000000CCFEFF7F6FF0CFFF7000000000000000000E7EFF7FFFE6CFF76000000000000000000F7EFE1EFF6F8FFB2000000000000000000E1E1E1E3F8493FF2000000000000000000000000000439FFF200000000000000000FC100E7000C31FF3100000000000000000FD3C7EF9F0C86FFF000000000000000000FF7E7EFBF087FFF3000000000000000000FF7E7EFBF00FFFF7000000000000000000FF7FFEFFF8FEFFFF000000000000000000FF7FFEFFFEF1FFFF100000000000000008FFFFFEFFFFF3EFFF100000000000000008FFFFFEFFFFF7EFFF100000000000000008FFFFFFFFFFFFEFFF100000000000000008FFFFFFFBFFDFEFFF100000000000000008FFFFFFFBFFDFFFFE100000000000000008FFFFFFFFFFFFFFF120000000000000000CFFFFFFFFFFFFFFF130000000000000000CFFFFFFFFFFFFFFFA20000000000000000CFFFFFFFFFFFF7FFA20000000000000000CFFFFFFFF7FF97FF120000000000000000CF7FFFFFF7FFF7FFD100000000000000000C70EFFFBFFFF7FF3000000000000000000C70E1EF37FFF7FF3000000000000000000C70E1EF3308F3FF3000000000000000000C7000E7000038FF3000000000000000000000000000000CFF7000000000000000000000000000000EFFF000000000000000000000000000000EFFF000000000000000000000000000000CFFF0000000000000000000000000000000CFF00000000000000000000000000000008F700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E101E83E001001000000000000000000001281154110100100000000000000000008C5411541109369311935E000000000000824011541105495492543110000000000082501E97E10971D7AA871F1000000000008C40101401254150AA441100000000000001201154112569544446111000000000000E101E83E0C8569344851E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
} C=RSTK D1=C
D0=(5)EC1 A=DAT0.A D0=A
LC(2)$AA { A=DAT1.W DAT0=A.W D1+16 D0+16 C-1.B UPNC }


% Clear EC2
SKUBL {
$0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000087E0E700F7000EE3000000000000000000ECEF7CE73C000F3D0000000000000000003F6B38369B100F521000000000000000003521331692100F771000000000000000006331339393300EFF200000000000000000CE31331E9B700CFF2000000000000000008C31391E18F008EF20000000000000000088303C9F18C1E7CF300000000000000000EC383F9F9BC038CF7000000000000000003E3C7F189BF0181FF000000000000000003BFFFF3EFBF0300EF00000000000000000E1FFFFFFFFF0E00EF00000000000000000C87EFF7F6FE0CF1F7000000000000000000C7EFF3E6FE6CFB76000000000000000000E3E7E1EFF498F932000000000000000000C0C0C0C160492042000000000000000000000000000429E10200000000000000000FC100E7000C11F10100000000000000000BD3C76C9F0486F0E0000000000000000001766620BD084F3E30000000000000000001042420A800BF7F70000000000000000001043C2FE88FEFFFB000000000000000000104182DC8E91FFF310000000000000000810C182DC8303AFE71000000000000000080C9892FC8106AFEF1000000000000000080C9893FE817CEFFF1000000000000000080CBD130A80D8EFFF100000000000000008CFB9130A8198F3FE100000000000000008CF71030E81D8F3E120000000000000000CCF5102EC8378F7E0200000000000000004CFDF32EC870CFF70200000000000000004CFBF36FEDF0F7F7020000000000000000CE7FF7FFF7FD17FF020000000000000000CF75FFFFB7FFB7FFD100000000000000000C70EFFF37FFF7FF3000000000000000000C70E1CF33EDF3F72000000000000000000C70C0EF1000F1F7200000000000000000083000C3000008F72000000000000000000000000000000CFF5000000000000000000000000000000EFFF0000000000000000000000000000002CEF000000000000000000000000000000CFFF000000000000000000000000000000040D00000000000000000000000000000008F700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E101E83E001001000000000000000000001281154110100100000000000000000008C5411541109369311935E000000000000824011541105495492543110000000000082501E97E10971D7AA871F1000000000008C40101401254150AA441100000000000001201154112569544446111000000000000E101E83E0C8569344851E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
} C=RSTK D1=C
D0=(5)EC2 A=DAT0.A D0=A
LC(2)$AA { A=DAT1.W DAT0=A.W D1+16 D0+16 C-1.B UPNC }



% Recuperation de l'adresse du gestionnaire
A=PC % A.A contient l'adresse de la prochaine instruction
GOINC .MyInt % Saut entre ici et le label
C+A.A % C.A contient l'adresse du gestionnaire

% Gestionnaire d'interruption
GOTOL _EndGest
*.MyInt

% ---- Setup IntMan ---
% Il s'agi de la procédure de mis en place du gestionnaire d'interruption.
% Attention: il faut toujours appeller RemoveIntMan quand on quitte le programe
*GRISON
D0=(5)HORLOGE LC(2)$70 DAT0=C.B % Prend le controle sur l'horloge 2 et inhibe la 1
D0=(2)$38 C=0.W C+10.A DAT0=C.8 % Place du temps dans l'horloge pour qu'on ait une interruption
A=PC GOINC IntMan         	% Calcul l'adresse du gestionnaire
C+A.A D0=(5)GEST A=DAT0.16 	% Sauvegarde des adresses de detournement
D1=(5)SAVE_IT DAT1=A.16
DAT0=C.A D0+10 DAT0=C.A 	% Detourne les inters
RTN

% ------ Int Man ------
% Il ne s'agit pas d'une procédure. Il ne faut donc pas l'appeller.
% Voir: SetupIntMan RemoveIntMan
*IntMan
%si l'interruption est due à l'horloge 2
D1=(5)HORLOGE2 C=DAT1.B
?CBIT=1.3 GOYES IntMan.Suite
GOTO IntMan.Fin

*IntMan.Suite
LC(2)$07 DAT1=C.B
%Pour etre sur que l'horloge est bien configurer l'Attente VBL
D1=(5)HEADERADD C=0.W { C=DAT1.6 ?C#0.W UP }

% Affichage des ecrans
D1=(5)COEFFIMAGE A=DAT1.P A-1.A
?A#0.P SKIPYES  % On cherche quel est l'ecran a afficher
{
   LA(1)$3 DAT1=A.P D1=(5)EC1 A=DAT1.A
   % Le fait de mettre 3 comme coefficient d'image permet d'afficher l'ecran 2
   % deux fois plus longtemps que le 1 et donc d'avoir 4 gris
}
SKELSE
{
   DAT1=A.P D1=(5)EC2 A=DAT1.A
}
D1=(5)SCREENADD DAT1=A.A % On ecrit l'ecran
ST=1.0

% Recharge horloge pour avoir une inter dans un peu moins d'une vbl
C=0.W LC(3)$07C
D1=(5)TIMER2 DAT1=C.8
D1=(5)COUNT_IT C=DAT1.W C+1.W DAT1=C.W
% Le gestionnaire contient
% egalement une variable contenant le nombre d'interruption effectuees

*IntMan.Fin % On restaure les registres sauvegardes par la routine
D1=(5)REGBK A=DAT1.W
D1-5 C=DAT1.A RSTK=C
D1-5 C=DAT1.A HST=2.2 %HST=02
CSR.A P=0 C+1.P SKIPC { SETDEC }
P=1 C-1.P P=C.2 D1=(5)WTF
C=DAT1.W D1=C C=RSTK
ST=0.14
RTI

% ---- RemoveIntMan ---
% Cette procédure doit être appellé quand on quitte le programe :
% elle réinitialise tout
*GRISOFF
LC 10 D0=(5)HORLOGE DAT0=C.B
D0=(5)SAVE_IT A=DAT0.15
D1=(5)GEST DAT1=A.15
D1=(5)SAV_TIMER C=DAT1.8
D1+8 A=DAT1.W ASLC
A+A.W A+A.W C+A.W
D1=(5)TIMER2 DAT1=C.8
D0=(5)SAVSCREEN
C=DAT0.A D0=(5)SCREENADD DAT0=C.A

% Restauration menu écran
D0=(5)SCREEN D1=(5)SCREENADD C=DAT0.A DAT1=C.A
D0=(2)$95 D1=(2)$30 C=DAT0.A DAT1=C.A
RTN

*_EndGest


GOSUBL GRISON

% Main loop
{

 GOSUBL TEST_QUIT  	% Quit if we press ENTER key
 UP
}

*TEST_QUIT
LC 001 GOSBVL =KEY
?CBIT=0.0 RTNYES
*QUIT
LC(3)$1FF
GOSBVL =KEY
?C#0.X GOYES QUIT

D1=(5)HEADERADD LC 7 DAT1=C.1 	% Show menu


GOSUBL GRISOFF
INTON
LOADRPL


ENDCODE
;
@


